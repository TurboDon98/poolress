# Обзор функционала `main.py` (Backend)

Ниже приведен подробный список реализованных модулей и API-эндпоинтов в файле `backend_old/app/main.py`.

## 1. Аутентификация (Auth)
Реализована базовая система регистрации и входа с использованием сессий (токенов) в базе данных.
*   `POST /api/auth/register` - Регистрация нового пользователя (email, username, full_name, password, role).
*   `POST /api/auth/login` - Вход (по email или username).
*   `GET /api/auth/me` - Получение данных текущего пользователя по токену.
*   `POST /api/auth/logout` - Выход (удаление сессии).
*   *Вспомогательное:* Хеширование паролей (pbkdf2), управление сессиями `UserSession`.

## 2. Системные функции
*   `GET /api/health` - Проверка состояния сервера и подключения к БД.
*   `GET /api/sys/user` - **Windows-specific**: Пытается определить текущего пользователя ОС (Login, Full Name, Email) через PowerShell и системные команды.

## 3. Настройки (Settings)
Управление производственным календарем (рабочие дни, выходные, праздники).
*   `GET /api/settings/calendar` - Получение текущего календаря (рабочие часы, исключения).
*   `PUT /api/settings/calendar` - Ручное сохранение настроек календаря.
*   `POST /api/settings/calendar/upload-mpp` - Загрузка календаря из файла MS Project (.mpp). Извлекает праздники и исключения из файла.

## 4. Проекты (Projects)
Основной блок работы с файлами MS Project (.mpp). Использует библиотеку `Aspose.Tasks`.
*   `POST /api/projects/upload` - Загрузка одного или нескольких .mpp файлов.
    *   Парсит метаданные (имя, автор, даты, прогресс).
    *   Сохраняет файл на диск и запись в БД (`ProjectFile`, `ProjectMeta`).
    *   Удаляет старые версии проекта с тем же именем.
*   `GET /api/projects/files` - Список всех загруженных проектов.
*   `DELETE /api/projects/files/{file_id}` - Удаление проекта и файла.
*   `GET /api/projects/overdue_tasks` - Список просроченных задач по конкретному проекту.
*   `GET /api/projects/shift_tasks` - (Название может сбивать, по коду это **анализ загрузки ресурсов** по проекту за период). Возвращает задачи, сгруппированные по ресурсам.
*   **WebSockets**: `/ws/projects` - Оповещение клиентов об изменениях в списке проектов.

**Отладка (Debug):**
*   `/api/projects/debug_parse/{file_id}` - Детальная инфо о парсинге метаданных.
*   `/api/projects/debug_tasks/{file_id}` - Вывод первых 10 задач и ресурсов (для проверки чтения файла).
*   `/api/projects/debug_introspect/{file_id}` - Техническая инфо о доступных полях объекта Project в Aspose.

## 5. Ресурсы (Resources)
Управление пулом сотрудников и анализ их занятости.
*   `POST /api/resources/extract` - Просто парсинг загруженных файлов и возврат структуры ресурсов (Отдел -> Сотрудники) без сохранения.
*   `POST /api/resources/upload_store` - Загрузка файлов для формирования **Глобального справочника ресурсов**. Сохраняет людей, отделы, должности в таблицу `ResourcePerson`.
*   `GET /api/resources/current` - Получение текущего глобального справочника ресурсов.
*   `DELETE /api/resources/current` - Очистка справочника.
*   `GET /api/resources/person_projects` - Поиск всех проектов, где задействован конкретный сотрудник (по имени).
*   `POST /api/resource-check/analyze` - **Сводный анализ загрузки**.
    *   Принимает файл "плана" и сравнивает его с "банком проектов" (загруженными ранее проектами).
    *   Строит отчет по утилизации ресурсов (кто перегружен, у кого сколько часов) за конкретный месяц.

## 6. Аналитика качества (Quality / PK)
Глубокий анализ качества планирования в MS Project.
*   `POST /api/analyze-msproject` - Большой отчет "Здоровье проекта". Проверяет:
    *   Задачи без предшественников/последователей.
    *   Задачи с ручными ограничениями (не ASAP).
    *   Задачи с длительностью > 10 дней.
    *   "Висящие" суммарные задачи (> 1 мес).
    *   Проверка наличия базовых планов (Baselines).
    *   Специфичные проверки: наличие задач "Разработка ТЗ", "Испытания", "5S" и т.д. (по ключевым словам).
*   `POST /api/pk/final/analyze` - Аналогичный, но более строгий или "финальный" анализ паспорта качества. Проверяет структуру, вехи, наличие "Совета по качеству" и т.д.

---

**Жду вашего решения:**
Напишите, какие пункты (1-6) или отдельные подпункты мы оставляем для нового `backend`, а какие можно вырезать.
